<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sommelier Digital</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ·</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --gold-dim: rgba(212,175,55,0.15); --blanc: #ffffff; --card-bg: rgba(0,0,0,0.25); }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: radial-gradient(circle at center, #800020 0%, #3a000e 100%);
            color: var(--blanc);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        header { text-align: center; padding: 60px 20px 30px; width: 100%; }
        header h1 { font-size: clamp(2.2rem, 8vw, 3.5rem); font-weight: 800; }
        .ia-focus { color: var(--gold); }
        #subtitol { margin-top: 10px; opacity: 0.85; font-size: 1rem; }

        .search-area { width: 95%; max-width: 700px; margin: 20px auto 0; }
        .input-wrapper { width: 100%; position: relative; display: flex; align-items: center; }
        #chat-input {
            width: 100%; padding: 20px 60px 20px 30px;
            border-radius: 50px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.07); color: white;
            font-size: 1.1rem; text-align: center; outline: none;
            -webkit-appearance: none; transition: border 0.3s;
        }
        #chat-input:focus { border-color: var(--gold); }
        #btn-veu {
            position: absolute; right: 15px; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; padding: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        #btn-veu.listening { animation: pulse-gold 1.5s infinite; border-radius: 50%; }
        @keyframes pulse-gold {
            0%   { box-shadow: 0 0 0 0 rgba(212,175,55,0.4); }
            70%  { box-shadow: 0 0 0 15px rgba(212,175,55,0); }
            100% { box-shadow: 0 0 0 0 rgba(212,175,55,0); }
        }

        #response-container {
            width: 100%; margin-top: 30px;
            background: rgba(255,255,255,0.07);
            border-radius: 20px; padding: 28px;
            display: none; backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .loading { text-align: center; padding: 20px; opacity: 0.8; font-style: italic; }

        .bloc-text { font-size: 1.05rem; line-height: 1.8; margin-bottom: 20px; }
        .etiqueta {
            display: inline-block; font-size: 0.7rem; font-weight: 800;
            letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--gold); border: 1px solid var(--gold);
            border-radius: 20px; padding: 3px 12px; margin-bottom: 12px;
        }

        .vi-hero {
            display: flex; gap: 24px; align-items: flex-start;
            background: var(--card-bg); border-radius: 16px;
            padding: 24px; margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .vi-hero img { width: 120px; height: 200px; object-fit: contain; flex-shrink: 0; border-radius: 8px; }
        .vi-hero-info h2 { font-size: 1.3rem; font-weight: 800; color: var(--gold); margin-bottom: 6px; }
        .vi-hero-info .do-badge {
            font-size: 0.75rem; background: var(--gold-dim); color: var(--gold);
            border-radius: 20px; padding: 2px 10px; display: inline-block; margin-bottom: 12px;
        }
        .vi-hero-info p { font-size: 0.95rem; line-height: 1.7; opacity: 0.9; }
        .maridatge-list { margin-top: 14px; }
        .maridatge-list span {
            display: inline-block; background: rgba(255,255,255,0.08);
            border-radius: 20px; padding: 4px 14px; margin: 4px 4px 0 0;
            font-size: 0.85rem;
        }

        .plat-header {
            background: var(--card-bg); border-radius: 16px; padding: 20px 24px;
            margin-bottom: 24px; border-left: 3px solid var(--gold);
        }
        .plat-header h2 { font-size: 1.2rem; font-weight: 800; color: var(--gold); margin-bottom: 8px; }
        .plat-header p { font-size: 0.95rem; line-height: 1.7; opacity: 0.9; }

        .vins-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px; width: 100%;
        }
        @media (max-width: 500px) { .vins-grid { grid-template-columns: 1fr; } }

        .vi-card {
            background: var(--card-bg); border-radius: 14px; padding: 18px;
            text-align: center; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            transition: transform 0.2s, border-color 0.2s;
        }
        .vi-card:hover { transform: translateY(-3px); border-color: var(--gold); }
        .vi-card img { height: 160px; max-width: 90%; object-fit: contain; border-radius: 6px; }
        .vi-card .nom { font-size: 0.85rem; font-weight: 800; color: var(--gold); line-height: 1.3; }
        .vi-card .do  { font-size: 0.75rem; opacity: 0.6; margin-top: 2px; }
        .vi-card .justificacio { font-size: 0.8rem; opacity: 0.85; line-height: 1.5; margin-top: 4px; }

        .consell {
            margin-top: 24px; padding: 16px 20px;
            background: var(--gold-dim); border-radius: 12px;
            border-left: 3px solid var(--gold);
            font-size: 0.9rem; line-height: 1.6; font-style: italic;
        }
        .consell::before { content: 'ğŸ· '; }

        .error-msg { text-align: center; padding: 20px; opacity: 0.8; color: #ff9999; }

        #btn-borrar {
            display: block; margin: 28px auto 0;
            padding: 12px 32px; border-radius: 50px;
            border: 1px solid var(--gold); background: transparent;
            color: var(--gold); cursor: pointer; transition: 0.3s;
            font-family: inherit; font-size: 0.95rem;
        }
        #btn-borrar:hover { background: var(--gold-dim); }

        /* â”€â”€ Beta banner â”€â”€ */
        .beta-banner {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(212,175,55,0.08);
            border: 1px solid rgba(212,175,55,0.25);
            border-radius: 20px; padding: 5px 16px;
            font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;
            color: rgba(212,175,55,0.75); text-transform: uppercase;
            margin-bottom: 16px;
        }
        .beta-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--gold); flex-shrink: 0;
            animation: parpelleig 2s ease-in-out infinite;
        }
        @keyframes parpelleig {
            0%, 100% { opacity: 1; } 50% { opacity: 0.15; }
        }

        /* â”€â”€ Footer â”€â”€ */
        footer {
            padding: 30px 20px 40px; font-size: 0.75rem;
            text-align: center; margin-top: auto; line-height: 2;
            opacity: 0.5;
        }
        .disclaimer {
            margin-top: 4px; font-size: 0.68rem; opacity: 0.75;
            max-width: 480px; margin-left: auto; margin-right: auto;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<header>
    <h1>SommelierDig<span class="ia-focus">i</span>t<span class="ia-focus">a</span>l</h1>
    <p id="subtitol"></p>
    <div style="margin-top:16px;">
        <span class="beta-banner"><span class="beta-dot"></span>ğŸ§ª Beta Â· En construcciÃ³</span>
    </div>
</header>

<main class="search-area">
    <div class="input-wrapper">
        <input type="text" id="chat-input" autocomplete="off">
        <button id="btn-veu" aria-label="Cerca per veu">ğŸ™ï¸</button>
    </div>
    <div id="response-container">
        <div id="output"></div>
        <button id="btn-borrar"></button>
    </div>
</main>

<footer>
    <p id="footer-text"></p>
    <p class="disclaimer" id="disclaimer-text"></p>
</footer>

<script>
const i18n = {
    ca: { subtitol: "El teu cercador de vins intelÂ·ligent", placeholder: "Maridatge, un plat o un vi...", loading: "Consultant el celler...", btn: "Nova consulta", footer: "Pere Badia i Lorenz Â© 2026 Â· Tots els drets reservats", disclaimer: "Les recomanacions les genera una IA i poden contenir errors. L'autor no es responsabilitza de les decisions preses basant-se en aquesta informaciÃ³." },
    es: { subtitol: "Tu buscador de vinos inteligente",     placeholder: "Maridaje, un plato o un vino...", loading: "Consultando bodega...",  btn: "Nueva consulta",  footer: "Pere Badia i Lorenz Â© 2026 Â· Todos los derechos reservados", disclaimer: "Las recomendaciones las genera una IA y pueden contener errores. El autor no se responsabiliza de las decisiones tomadas basÃ¡ndose en esta informaciÃ³n." },
    fr: { subtitol: "Votre moteur de recherche de vins",    placeholder: "Accord mets-vins, un plat...",  loading: "Consultation cave...",    btn: "Nouvelle recherche", footer: "Pere Badia i Lorenz Â© 2026 Â· Tous droits rÃ©servÃ©s", disclaimer: "Les recommandations sont gÃ©nÃ©rÃ©es par une IA et peuvent contenir des erreurs. L'auteur dÃ©cline toute responsabilitÃ© quant aux dÃ©cisions prises sur la base de ces informations." },
    en: { subtitol: "Your intelligent wine search engine",  placeholder: "Pairing, a dish or a wine...", loading: "Consulting the cellar...", btn: "New search",      footer: "Pere Badia i Lorenz Â© 2026 Â· All rights reserved", disclaimer: "Recommendations are AI-generated and may contain errors. The author is not responsible for any decisions made based on this information." },
};

const userLang = (navigator.language || 'ca').split('-')[0];
const t = i18n[userLang] || i18n['ca'];

const $ = id => document.getElementById(id);
$('subtitol').textContent   = t.subtitol;
$('chat-input').placeholder = t.placeholder;
$('footer-text').textContent = t.footer;
$('disclaimer-text').textContent = t.disclaimer;
$('btn-borrar').textContent  = t.btn;

// â”€â”€ Filtre DO: mai mostrem noms de botiga â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PARAULES_BOTIGA = ['viniteca', 'vila', 'botiga', 'shop', 'store', 'bodega'];
function doValida(do_str) {
    if (!do_str || !do_str.trim()) return '';
    const d = do_str.toLowerCase();
    return PARAULES_BOTIGA.some(k => d.includes(k)) ? '' : do_str.trim();
}

// â”€â”€ Imatge amb fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IMG_FALLBACK = 'https://images.vivino.com/thumbs/default_label_600x600.png';
function imgTag(url, alt) {
    const src = url || IMG_FALLBACK;
    return `<img src="${src}" alt="${alt || ''}" onerror="this.src='${IMG_FALLBACK}'">`;
}

// â”€â”€ Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderVi(d) {
    const vi  = d.vi_principal || {};
    const do_ = doValida(vi.do);
    const plats = (d.maridatge_suggerit || []).map(p => `<span>${p}</span>`).join('');
    return `
        <div class="etiqueta">Vi</div>
        <div class="vi-hero">
            ${imgTag(vi.imatge, vi.nom)}
            <div class="vi-hero-info">
                <h2>${vi.nom || ''}</h2>
                ${do_ ? `<span class="do-badge">${do_}</span>` : ''}
                <p>${d.descripcio || ''}</p>
                ${plats ? `<div class="maridatge-list">${plats}</div>` : ''}
            </div>
        </div>`;
}

function renderPlat(d) {
    const plat = d.plat || {};
    const cardsHtml = (d.vins_recomanats || []).slice(0, 3).map(v => {
        const do_ = doValida(v.do);
        return `
        <div class="vi-card">
            ${imgTag(v.imatge, v.nom)}
            <div class="nom">${v.nom || ''}</div>
            ${do_ ? `<div class="do">${do_}</div>` : ''}
            <div class="justificacio">${v.justificacio || ''}</div>
        </div>`;
    }).join('');

    return `
        <div class="etiqueta">Plat tÃ­pic</div>
        <div class="plat-header">
            <h2>${plat.nom || ''}</h2>
            <p>${plat.descripcio || ''}</p>
        </div>
        <div class="vins-grid">${cardsHtml}</div>`;
}

function renderMaridatge(d) {
    const cardsHtml = (d.vins_recomanats || []).slice(0, 3).map(v => {
        const do_ = doValida(v.do);
        return `
        <div class="vi-card">
            ${imgTag(v.imatge, v.nom)}
            <div class="nom">${v.nom || ''}</div>
            ${do_ ? `<div class="do">${do_}</div>` : ''}
            <div class="justificacio">${v.justificacio || ''}</div>
        </div>`;
    }).join('');

    const consell = d.consell_sommelier
        ? `<div class="consell">${d.consell_sommelier}</div>` : '';

    return `
        <div class="etiqueta">Maridatge</div>
        <div class="bloc-text">${d.introduccio || ''}</div>
        <div class="vins-grid">${cardsHtml}</div>
        ${consell}`;
}

// â”€â”€ Renderitzador principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResposta(data) {
    const output = $('output');
    if (data.error) { output.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    const r = data.resposta;
    if (!r || !r.tipus_resposta) { output.innerHTML = `<div class="error-msg">No hem pogut processar la resposta.</div>`; return; }

    switch (r.tipus_resposta) {
        case 'vi':        output.innerHTML = renderVi(r);        break;
        case 'plat':      output.innerHTML = renderPlat(r);      break;
        case 'maridatge': output.innerHTML = renderMaridatge(r); break;
        default:          output.innerHTML = `<div class="error-msg">Tipus de resposta desconegut.</div>`;
    }
}

// â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processarCerca(pregunta) {
    if (!pregunta || !pregunta.trim()) return;
    $('response-container').style.display = 'block';
    $('output').innerHTML = `<div class="loading">ğŸ· ${t.loading}</div>`;

    try {
        const res = await fetch('/api/sommelier', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pregunta: pregunta.trim(), idioma: userLang }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        renderResposta(await res.json());
    } catch (err) {
        console.error('[frontend]', err);
        $('output').innerHTML = `<div class="error-msg">Error de connexiÃ³. Torna a intentar-ho.</div>`;
    }
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') processarCerca($('chat-input').value); });
$('btn-borrar').addEventListener('click', () => {
    $('response-container').style.display = 'none';
    $('chat-input').value = '';
    $('chat-input').focus();
});

// â”€â”€ Veu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SR) {
    const rec = new SR();
    const langMap = { ca: 'ca-ES', es: 'es-ES', fr: 'fr-FR', en: 'en-US' };
    $('btn-veu').addEventListener('click', () => { rec.lang = langMap[userLang] || 'ca-ES'; rec.start(); $('btn-veu').classList.add('listening'); });
    rec.onresult = e => { const text = e.results[0][0].transcript; $('chat-input').value = text; $('btn-veu').classList.remove('listening'); processarCerca(text); };
    rec.onend    = () => $('btn-veu').classList.remove('listening');
    rec.onerror  = () => $('btn-veu').classList.remove('listening');
} else {
    $('btn-veu').style.display = 'none';
}
</script>
</body>
</html>
